<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Soroban Vision - Retina Burn</title>
<style>
  :root {
    /* === 脳内定着・残像特化カラーパレット === */
    --bg-color: #000000;       /* 完全な闇 */
    --text-color: #00ffff;     /* 文字：シアン */
    --accent: #00ffff;         /* アクセント：シアン */
    
    /* === 光るそろばん設定 === */
    --abacus-bg: #000000;      /* 背景も黒で統一（珠だけ浮かばせる） */
    --frame-color: #333333;    /* 枠は目立たせない（暗いグレー） */
    --rod-color: #222222;      /* 軸もほぼ見えない暗さ */
    --beam-color: #ffffff;     /* 梁：強烈な白（基準線） */
    
    /* 珠の色：発光体としてデザイン */
    /* 中心は白く、周りがシアンに光る */
    --bead-core: #e0ffff;      /* 珠の中心（ほぼ白） */
    --bead-glow: #00ffff;      /* 珠の発光色（ネオンシアン） */
    --bead-border: #008b8b;    /* 輪郭 */

    /* === サイズ設定（絶対配置・横向き最適化） === */
    --bead-h: 32px;
    --bead-w: 58px;
    --gap-size: 55px;          /* 動きの幅 */
    --beam-h: 8px;             /* 梁の太さ */
  }

  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
  }

  .container {
    width: 100%;
    max-width: 900px;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%;
    padding: 10px 0;
    text-align: center;
    border-bottom: 1px solid #333;
    margin-bottom: 15px;
  }
  h1 { 
    margin: 0; 
    font-size: 1.5rem; 
    letter-spacing: 3px; 
    color: var(--accent);
    text-shadow: 0 0 10px var(--accent); /* タイトルも光らせる */
  }

  /* メニュー */
  #menu-screen {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    width: 100%;
  }
  .menu-card {
    background: #111;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #333;
    cursor: pointer;
    width: 260px;
    transition: 0.2s;
    text-align: center;
    box-shadow: 0 0 5px rgba(0, 255, 255, 0.1);
  }
  .menu-card:hover { 
    background: #000; 
    border-color: var(--accent); 
    box-shadow: 0 0 20px var(--accent); /* ホバーで発光 */
  }
  .menu-card h3 { margin: 0 0 10px; color: var(--accent); }
  .menu-card p { font-size: 0.8rem; color: #aaa; margin: 0; }

  /* ゲーム画面 */
  .game-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }

  .display-area {
    background: var(--abacus-bg);
    width: 100%;
    height: 380px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    position: relative;
    border: 2px solid #333;
    overflow: hidden;
  }

  /* === そろばん ビジュアル (光の珠) === */
  .abacus-visual {
    display: flex;
    gap: 20px; /* 珠の間隔を広げて個別に認識させる */
    padding: 20px 40px;
    background: #000; 
    border: 2px solid #222; /* 枠は極力消す */
    border-radius: 8px;
    position: relative;
  }

  .column {
    position: relative;
    width: var(--bead-w);
    height: calc(var(--bead-h) * 5 + var(--gap-size) * 2 + var(--beam-h));
  }

  .rod {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: 0; bottom: 0;
    width: 2px;
    background: var(--rod-color);
    z-index: 0;
  }

  .beam {
    position: absolute;
    top: calc(var(--bead-h) + var(--gap-size));
    left: -30%; width: 160%;
    height: var(--beam-h);
    background: var(--beam-color);
    z-index: 10;
    /* 梁を強烈に光らせる（基準線） */
    box-shadow: 0 0 15px #ffffff, 0 0 5px #00ffff;
    border-radius: 2px;
  }

  .bead {
    position: absolute;
    left: 0;
    width: var(--bead-w);
    height: var(--bead-h);
    
    /* === 珠のデザイン：発光体 === */
    /* 中心から外に向かってグラデーション */
    background: radial-gradient(circle at 40% 40%, var(--bead-core), var(--bead-glow) 90%);
    
    border-radius: 50px; /* カプセル型 */
    border: 1px solid var(--bead-border);
    box-sizing: border-box;
    z-index: 5;
    
    /* === 輝度最大対策：グロー効果 === */
    /* これが残像の鍵です */
    box-shadow: 0 0 10px var(--bead-glow), inset 0 0 5px rgba(255,255,255,0.5);
    
    transition: transform 0.1s cubic-bezier(0.25, 1, 0.5, 1);
  }

  /* 配置ロジック (絶対配置・重なりなし) */
  .bead-5 { top: 0; }
  /* 天の珠がON: ギャップ分降りる */
  .five-on .bead-5 { transform: translateY(var(--gap-size)); }

  /* 地の珠の初期位置 (OFF状態) */
  .b4 { top: calc(var(--bead-h) + var(--gap-size) + var(--beam-h) + var(--gap-size)); }
  .b3 { top: calc(var(--bead-h) + var(--gap-size) + var(--beam-h) + var(--gap-size) + var(--bead-h)); }
  .b2 { top: calc(var(--bead-h) + var(--gap-size) + var(--beam-h) + var(--gap-size) + var(--bead-h) * 2); }
  .b1 { top: calc(var(--bead-h) + var(--gap-size) + var(--beam-h) + var(--gap-size) + var(--bead-h) * 3); }

  /* 地の珠がON: ギャップ分上がる */
  .one-1 .b4 { transform: translateY(calc(var(--gap-size) * -1)); }
  .one-2 .b4, .one-2 .b3 { transform: translateY(calc(var(--gap-size) * -1)); }
  .one-3 .b4, .one-3 .b3, .one-3 .b2 { transform: translateY(calc(var(--gap-size) * -1)); }
  .one-4 .b4, .one-4 .b3, .one-4 .b2, .one-4 .b1 { transform: translateY(calc(var(--gap-size) * -1)); }

  /* コントロール */
  .controls { display: flex; gap: 20px; margin-top: 10px; }
  button {
    padding: 12px 35px;
    font-size: 16px;
    border: 2px solid var(--accent);
    border-radius: 50px; /* 丸ボタン */
    background: #000;
    color: var(--accent);
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,255,255,0.2);
    transition: 0.1s;
  }
  button:active { 
    background: var(--accent); 
    color: #000; 
    box-shadow: 0 0 20px var(--accent);
  }
  button.secondary { border-color: #555; color: #888; box-shadow: none; }
  
  .settings-box {
    margin-top: 15px;
    padding: 10px;
    color: #888;
    font-size: 0.9rem;
    border-top: 1px solid #333;
  }
  select { background: #000; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 4px; }

  /* フラッシュの数字も光らせる */
  .big-text { 
    font-size: 120px; 
    font-weight: bold; 
    color: #fff; 
    text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
  }
  .flash-bar { 
    position: absolute; bottom: 0; left: 0; height: 4px; 
    background: var(--accent); width: 0%; 
    box-shadow: 0 0 10px var(--accent); 
  }
  
  .instruction {
    position: absolute; top: 10px; left: 10px;
    font-size: 0.8rem; color: #666;
    background: #111; padding: 5px 10px;
    border: 1px solid #333;
    border-radius: 4px;
    z-index: 20;
  }

</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Soroban Vision <span style="font-size:0.5em; vertical-align:middle; color:#555;">Neon Edition</span></h1>
  </header>

  <div id="menu-screen">
    <div class="menu-card" onclick="startMode(1)">
      <h3>1. 残像定着</h3>
      <p>黒闇に浮かぶ「光の珠」を焼き付ける。<br>目を閉じると浮かび上がります。</p>
    </div>
    <div class="menu-card" onclick="startMode(2)">
      <h3>2. ムービング・シャドー</h3>
      <p>白く光る梁（はり）に<br>吸い付く動きを追う。</p>
    </div>
    <div class="menu-card" onclick="startMode(3)">
      <h3>3. 瞬間フラッシュ</h3>
      <p>数字を「光の形」に変換する。</p>
    </div>
  </div>

  <!-- Mode 1 -->
  <div id="game-1" class="game-screen">
    <div class="display-area" id="area-1">
      <div class="instruction">残像を焼き付けてください</div>
      <div id="abacus-1"></div>
    </div>
    <div class="controls">
      <button onclick="revealAnswer1()" id="btn-reveal-1">答え</button>
      <button onclick="nextProblem1()" id="btn-next-1" style="display:none;">次へ</button>
      <button class="secondary" onclick="goHome()">戻る</button>
    </div>
    <div class="settings-box">
      桁数: <select id="level-1"><option value="1">1桁</option><option value="2">2桁</option><option value="3">3桁</option></select>
      時間: <select id="speed-1"><option value="500">0.5秒</option><option value="1000" selected>1.0秒</option><option value="2000">2.0秒</option></select>
    </div>
  </div>

  <!-- Mode 2 -->
  <div id="game-2" class="game-screen">
    <div class="display-area" id="area-2">
      <div class="instruction">計算不要。動きを見るだけ</div>
      <div id="abacus-2"></div>
    </div>
    <div id="shadow-info" style="font-size: 24px; font-weight:bold; margin-bottom:10px; color: var(--accent); text-shadow: 0 0 10px var(--accent);">Ready</div>
    <div class="controls">
      <button onclick="startShadow()" id="btn-start-2">Start</button>
      <button class="secondary" onclick="goHome()">戻る</button>
    </div>
    <div class="settings-box">
      速度: <select id="speed-2"><option value="1500">ゆっくり</option><option value="800" selected>普通</option><option value="400">速い</option></select>
    </div>
  </div>

  <!-- Mode 3 -->
  <div id="game-3" class="game-screen">
    <div class="display-area">
      <div id="flash-number" class="big-text">Ready</div>
      <div class="flash-bar" id="bar"></div>
    </div>
    <div class="controls">
      <button onclick="startFlash()" id="btn-start-3">Start</button>
      <button onclick="showAnswer3()" id="btn-ans-3" style="display:none;">答え</button>
      <button class="secondary" onclick="goHome()">戻る</button>
    </div>
    <div class="settings-box">
      口数: <select id="count-3"><option value="3">3口</option><option value="5" selected>5口</option><option value="10">10口</option></select>
      速度: <select id="speed-3"><option value="1500">ゆっくり</option><option value="1000" selected>普通</option><option value="500">速い</option></select>
    </div>
  </div>
</div>

<script>
  function createAbacusHTML(number, digits) {
    let strNum = number.toString().padStart(digits, '0');
    let html = '<div class="abacus-visual">';
    for (let i = 0; i < digits; i++) {
      let n = parseInt(strNum[i]);
      let fiveOn = n >= 5;
      let oneVal = n % 5;
      let colClass = "column";
      if (fiveOn) colClass += " five-on";
      if (oneVal > 0) colClass += " one-" + oneVal;
      else colClass += " one-0";
      html += `<div class="${colClass}">
        <div class="rod"></div>
        <div class="bead bead-5"></div>
        <div class="beam"></div>
        <div class="bead bead-1 b4"></div>
        <div class="bead bead-1 b3"></div>
        <div class="bead bead-1 b2"></div>
        <div class="bead bead-1 b1"></div>
      </div>`;
    }
    html += '</div>';
    return html;
  }

  function goHome() {
    document.querySelectorAll('.game-screen').forEach(el => el.style.display = 'none');
    document.getElementById('menu-screen').style.display = 'flex';
    clearTimeout(timer); clearTimeout(shadowInterval);
  }
  function startMode(mode) {
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('game-' + mode).style.display = 'flex';
    if(mode === 1) nextProblem1();
    if(mode === 2) resetShadow();
    if(mode === 3) document.getElementById('flash-number').textContent = "Ready";
  }

  // Mode 1
  let currentAns1 = 0;
  function nextProblem1() {
    document.getElementById('btn-reveal-1').style.display = 'inline-block';
    document.getElementById('btn-next-1').style.display = 'none';
    let digits = parseInt(document.getElementById('level-1').value);
    let max = Math.pow(10, digits) - 1;
    let min = Math.pow(10, digits - 1);
    if(digits===1) min=0;
    currentAns1 = Math.floor(Math.random() * (max - min + 1)) + min;
    let container = document.getElementById('abacus-1');
    container.innerHTML = createAbacusHTML(currentAns1, digits);
    container.style.opacity = 1;
    let speed = parseInt(document.getElementById('speed-1').value);
    setTimeout(() => { container.style.opacity = 0; container.innerHTML = ""; }, speed);
  }
  function revealAnswer1() {
    let container = document.getElementById('abacus-1');
    container.innerHTML = `<div class="big-text" style="font-size:80px">${currentAns1}</div>`;
    container.style.opacity = 1;
    document.getElementById('btn-reveal-1').style.display = 'none';
    document.getElementById('btn-next-1').style.display = 'inline-block';
  }

  // Mode 2
  let shadowSum = 0;
  let shadowInterval;
  function resetShadow() {
    shadowSum = 0;
    document.getElementById('abacus-2').innerHTML = createAbacusHTML(0, 3);
    document.getElementById('shadow-info').textContent = "Startボタンを押してください";
  }
  function startShadow() {
    let btn = document.getElementById('btn-start-2');
    btn.disabled = true;
    shadowSum = 0;
    let count = 0;
    const maxCount = 10;
    const speed = parseInt(document.getElementById('speed-2').value);
    document.getElementById('abacus-2').innerHTML = createAbacusHTML(0, 3);
    function step() {
      if (count >= maxCount) {
        document.getElementById('shadow-info').textContent = "答え: " + shadowSum;
        btn.disabled = false;
        return;
      }
      let add = Math.floor(Math.random() * 9) + 1;
      if (count > 0 && Math.random() > 0.6 && shadowSum > 10) add = -1 * (Math.floor(Math.random() * 5) + 1);
      shadowSum += add;
      document.getElementById('shadow-info').textContent = add > 0 ? `+ ${add}` : `- ${Math.abs(add)}`;
      document.getElementById('abacus-2').innerHTML = createAbacusHTML(shadowSum, 3);
      count++;
      shadowInterval = setTimeout(step, speed);
    }
    step();
  }

  // Mode 3
  let flashNums = [], flashSum = 0, timer;
  function startFlash() {
    flashSum = 0; flashNums = [];
    document.getElementById('btn-start-3').style.display = 'none';
    document.getElementById('btn-ans-3').style.display = 'none';
    document.getElementById('flash-number').textContent = "";
    const count = parseInt(document.getElementById('count-3').value);
    const speed = parseInt(document.getElementById('speed-3').value);
    for(let i=0; i<count; i++) flashNums.push(Math.floor(Math.random() * 89) + 10);
    let i = 0;
    document.getElementById('flash-number').textContent = "3";
    setTimeout(()=>document.getElementById('flash-number').textContent="2", 600);
    setTimeout(()=>document.getElementById('flash-number').textContent="1", 1200);
    setTimeout(() => { runFlashLoop(0, count, speed); }, 1800);
  }
  function runFlashLoop(i, count, speed) {
    if (i >= count) {
      document.getElementById('flash-number').textContent = "Finish";
      document.getElementById('btn-ans-3').style.display = 'inline-block';
      document.getElementById('btn-start-3').style.display = 'inline-block';
      document.getElementById('btn-start-3').textContent = "もう一度";
      return;
    }
    let num = flashNums[i];
    flashSum += num;
    document.getElementById('flash-number').textContent = num;
    let bar = document.getElementById('bar');
    bar.style.width = '0%'; bar.style.transition = 'none';
    setTimeout(() => { bar.style.width = '100%'; bar.style.transition = `width ${speed}ms linear`; }, 10);
    timer = setTimeout(() => {
      document.getElementById('flash-number').textContent = ""; 
      setTimeout(() => { runFlashLoop(i + 1, count, speed); }, 100);
    }, speed);
  }
  function showAnswer3() {
    document.getElementById('flash-number').textContent = flashSum;
    document.getElementById('btn-ans-3').style.display = 'none';
  }
</script>
</body>
</html>
