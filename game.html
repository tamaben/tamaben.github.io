<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Galaxy Pizza Delivery</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap');
        
        body { margin: 0; overflow: hidden; background: #111; font-family: 'M PLUS Rounded 1c', sans-serif; user-select: none; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* å…±é€šã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; text-align: center; color: white;
        }
        .active { display: flex; }

        h1 { font-size: 3.5rem; margin: 10px; color: #ffeb3b; text-shadow: 4px 4px 0 #000; }
        p { font-size: 1.2rem; color: #aaa; margin-bottom: 30px; }

        /* æ¥ç¶šç”»é¢ */
        .setup-container {
            width: 80%; max-width: 800px; min-height: 300px;
            display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap;
            border-bottom: 2px solid #555; padding-bottom: 40px; margin-bottom: 20px;
        }

        /* Joy-Con ã‚¤ãƒ©ã‚¹ãƒˆ (CSSã§æç”») */
        .jc-illust {
            width: 60px; height: 140px; border-radius: 30px; 
            border: 4px solid rgba(255,255,255,0.2);
            position: relative; display: flex; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0); /* æœ€åˆã¯éè¡¨ç¤º */
            background: #555; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
        }
        .jc-illust.joined { transform: scale(1); border-color: #fff; }
        
        /* å·¦ã‚³ãƒ³ã®ç‰¹å¾´ */
        .jc-l .stick { width: 24px; height: 24px; background: #222; border-radius: 50%; position: absolute; top: 25px; left: 18px; }
        .jc-l .btns { position: absolute; top: 60px; left: 18px; width: 24px; height: 24px; }
        .jc-l .minus { position: absolute; top: 10px; right: 10px; width: 12px; height: 4px; background: #333; }
        
        /* å³ã‚³ãƒ³ã®ç‰¹å¾´ */
        .jc-r .stick { width: 24px; height: 24px; background: #222; border-radius: 50%; position: absolute; top: 60px; left: 18px; }
        .jc-r .btns { position: absolute; top: 25px; left: 18px; width: 24px; height: 24px; }
        .jc-r .plus { position: absolute; top: 8px; left: 10px; width: 12px; height: 12px; }
        .jc-r .plus::before { content:''; position:absolute; top:4px; left:0; width:12px; height:4px; background:#333; }
        .jc-r .plus::after { content:''; position:absolute; top:0; left:4px; width:4px; height:12px; background:#333; }

        .btn-dot { width: 8px; height: 8px; background: #222; border-radius: 50%; position: absolute; }
        .b-u { top: -6px; left: 8px; } .b-d { bottom: -6px; left: 8px; }
        .b-l { top: 8px; left: -6px; } .b-r { top: 8px; right: -6px; }

        /* ãƒ¬ãƒ¼ãƒ« (SL/SR) */
        .rail {
            position: absolute; top: 15px; bottom: 15px; width: 6px; background: #111;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }
        .jc-l .rail { right: -6px; border-radius: 0 4px 4px 0; }
        .jc-r .rail { left: -6px; border-radius: 4px 0 0 4px; }
        .sl-btn, .sr-btn { width: 4px; height: 15px; background: #555; margin: 10px 0; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå· */
        .p-tag {
            position: absolute; bottom: -40px; width: 100%; text-align: center;
            font-weight: bold; font-size: 1.2rem; color: #fff; text-shadow: 0 0 5px #000;
        }

        /* æ¥ç¶šã‚¬ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .guide-anim {
            width: 100px; height: 60px; border: 2px dashed #666; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; color: #666;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: #00e676; color: #000; border: none; padding: 15px 50px;
            font-size: 1.5rem; border-radius: 50px; cursor: pointer;
            font-family: inherit; font-weight: bold; box-shadow: 0 5px 0 #00b359;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        .btn:disabled { background: #555; box-shadow: none; color: #888; cursor: not-allowed; }

        /* ã‚²ãƒ¼ãƒ HUD */
        #game-hud {
            display: none; width: 100%; justify-content: space-between; padding: 20px 40px; box-sizing: border-box;
            color: #fff; text-shadow: 2px 2px 0 #000;
        }
        .dist-meter { font-size: 2rem; font-weight: bold; }
        
        #msg-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; font-weight: bold; text-shadow: 0 0 30px #fff; display: none;
        }
        
    </style>
    <!-- Three.js -->
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>
</head>
<body>

    <!-- 1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
    <div id="screen-setup" class="screen active">
        <h1>GALAXY PIZZA</h1>
        <p>Joy-Conã‚’PCã«Bluetoothæ¥ç¶šã—ã€ãƒ¬ãƒ¼ãƒ«ã«ã‚ã‚‹ <strong>SL + SR</strong> ã‚’åŒæ™‚ã«æŠ¼ã—ã¦ãã ã•ã„</p>
        
        <div class="setup-container" id="player-container">
            <!-- ã“ã“ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ ãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
            <div class="guide-anim">Waiting...</div>
        </div>

        <div>
            <button class="btn" id="connect-btn">Joy-Conã‚’PCã«èªè­˜ã•ã›ã‚‹</button>
            <br><br>
            <button class="btn" id="start-btn" style="background:#ffeb3b; display:none;">DELIVERY START!</button>
        </div>
    </div>

    <!-- 2. ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="ui-layer">
        <div id="game-hud">
            <div>ğŸš€ å”åŠ›ãƒãƒ©ãƒ³ã‚¹ã‚²ãƒ¼ãƒ </div>
            <div class="dist-meter">GOAL: <span id="dist-val">100</span>m</div>
        </div>
        <div id="msg-overlay">GOAL!</div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- éŸ³å£° (Switchã£ã½ã„ã‚¹ãƒŠãƒƒãƒ—éŸ³) ---
        const actx = new (window.AudioContext || window.webkitAudioContext)();
        function playSnapSound() {
            if(actx.state==='suspended') actx.resume();
            const osc = actx.createOscillator();
            const gain = actx.createGain();
            osc.connect(gain); gain.connect(actx.destination);
            osc.frequency.setValueAtTime(800, actx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, actx.currentTime+0.05);
            gain.gain.setValueAtTime(0.5, actx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+0.1);
            osc.start(); osc.stop(actx.currentTime+0.1);
        }

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let players = []; // ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        let scene, camera, renderer;
        let isPlaying = false;
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let ship, pizza;
        let obstacles = [];
        let gameProgress = 0;
        let shipVelocity = new THREE.Vector3(0,0,0);
        let pizzaVelocity = new THREE.Vector3(0,0,0);

        // --- Joy-Con Logic ---
        class JoyCon {
            constructor(device) {
                this.device = device;
                this.isRegistered = false;
                // 0x2006=L, 0x2007=R
                this.type = (device.productId === 0x2006) ? 'L' : 'R';
                // Joy-Conã‚«ãƒ©ãƒ¼ (ç°¡æ˜“å®šç¾©)
                this.color = this.type === 'L' ? '#00c3e3' : '#ff5252'; 
                
                this.tilt = { x: 0, z: 0 }; // ã‚¸ãƒ£ã‚¤ãƒ­å€¤
            }

            async init() {
                await this.device.open();
                // åˆæœŸåŒ–ãƒ‘ã‚±ãƒƒãƒˆ
                await this.send(0x01, [0x00, 0x01, 0x40, 0x40, 0x00, 0x01, 0x40, 0x40]); // Rumble Enable
                await this.send(0x01, [0x00, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]); // Subcmd Setup
                await this.sub(0x40, [0x01]); // IMU On
                await this.sub(0x03, [0x30]); // Standard Mode (60Hz)
                
                this.device.addEventListener('inputreport', this.handle.bind(this));
            }

            async send(cmd, data) { if(this.device.opened) await this.device.sendReport(cmd, new Uint8Array([cmd,...data])); }
            async sub(c, d) { await this.send(0x01, [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,c,...d]); }
            async rumble() {
                await this.send(0x10, [0x00,0x01,0x40,0x40,0x00,0x01,0x40,0x40]);
                setTimeout(()=>this.send(0x10,[0,0,0,0,0,0,0,0]), 150);
            }

            handle(e) {
                const dt = new DataView(e.data.buffer);
                if(e.reportId!==0x30 && e.reportId!==0x21) return;

                // --- 1. SL + SR åˆ¤å®š (ç™»éŒ²ç”¨) ---
                if (!this.isRegistered && !isPlaying) {
                    // Button Status Byte offsets
                    // Right(2007): Byte 3 (Shared) -> SL=0x20, SR=0x10
                    // Left(2006):  Byte 5 (Shared) -> SL=0x20, SR=0x10
                    
                    const btnByte = this.type === 'L' ? dt.getUint8(5) : dt.getUint8(3);
                    const sl = (btnByte & 0x20) !== 0;
                    const sr = (btnByte & 0x10) !== 0;

                    if (sl && sr) {
                        this.register();
                    }
                }

                // --- 2. ã‚¸ãƒ£ã‚¤ãƒ­ (ã‚²ãƒ¼ãƒ ç”¨) ---
                if (isPlaying) {
                    const ax = dt.getInt16(13, true) * 0.000244;
                    const ay = dt.getInt16(15, true) * 0.000244;
                    const az = dt.getInt16(17, true) * 0.000244;

                    // å‚¾ãè¨ˆç®— (æ°´å¹³æŒã¡æƒ³å®š)
                    // Xè»¸: å·¦å³ã®å‚¾ã (Roll)
                    // Zè»¸: å‰å¾Œã®å‚¾ã (Pitch)
                    // â€»Joy-Conã®åº§æ¨™ç³»ã«åˆã‚ã›ã¦èª¿æ•´
                    
                    let tx = -az; // å·¦å³
                    let tz = -ay; // å‰å¾Œ
                    
                    // Rã‚³ãƒ³ã¯åº§æ¨™ç³»ãŒä¸€éƒ¨åè»¢
                    if(this.type === 'R') { tx *= -1; tz *= -1; }

                    this.tilt.x = tx;
                    this.tilt.z = tz;
                }
            }

            register() {
                this.isRegistered = true;
                this.rumble();
                playSnapSound();
                addPlayerUI(this);
                players.push(this);
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
                document.getElementById('start-btn').style.display = 'inline-block';
                document.getElementById('connect-btn').style.display = 'none';
            }
        }

        // --- UIæ§‹ç¯‰ ---
        function addPlayerUI(jc) {
            const container = document.getElementById('player-container');
            const guide = container.querySelector('.guide-anim');
            if(guide) guide.style.display = 'none';

            // Joy-Con DOMç”Ÿæˆ
            const div = document.createElement('div');
            // è‰²ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·é †ã§å¤‰ãˆã¦ã¿ã‚‹ (Switchã£ã½ã„è‰²)
            const colors = ['#ff5252', '#00c3e3', '#ffeb3b', '#d500f9'];
            jc.color = colors[(players.length) % 4];

            div.className = `jc-illust jc-${jc.type.toLowerCase()}`;
            div.style.backgroundColor = jc.color;
            div.innerHTML = `
                <div class="rail"><div class="sl-btn"></div><div class="sr-btn"></div></div>
                <div class="minus"></div><div class="plus"></div>
                <div class="stick"></div>
                <div class="btns">
                    <div class="btn-dot b-u"></div><div class="btn-dot b-d"></div>
                    <div class="btn-dot b-l"></div><div class="btn-dot b-r"></div>
                </div>
                <div class="p-tag">P${players.length + 1}</div>
            `;
            
            container.appendChild(div);
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¦ã‚§ã‚¤ãƒˆ
            requestAnimationFrame(() => div.classList.add('joined'));
        }

        // --- æ¥ç¶šãƒœã‚¿ãƒ³ ---
        document.getElementById('connect-btn').onclick = async () => {
            const devs = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x057e }] });
            for (const d of devs) {
                // é‡è¤‡é˜²æ­¢
                // (ç°¡æ˜“å®Ÿè£…: JoyConã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ãŒinitã¯ãƒ«ãƒ¼ãƒ—å¤–ã§ã‚„ã‚‹ã¹ãã ãŒãƒ‡ãƒ¢ãªã®ã§éƒ½åº¦)
                const jc = new JoyCon(d);
                await jc.init();
                // å¾…æ©Ÿãƒªã‚¹ãƒˆã«å…¥ã‚Œã‚‹ç­‰ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€
                // ã“ã“ã§ã¯ã€Œæ¥ç¶šï¼ç›£è¦–é–‹å§‹ã€ã¨ã™ã‚‹
            }
        };

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('screen-setup').style.display = 'none';
            document.getElementById('game-hud').style.display = 'flex';
            init3D();
            isPlaying = true;
        };


        // --- 3Dã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ  ---
        function init3D() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x16213e, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 10, 12);
            camera.lookAt(0, 0, -5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // ãƒ©ã‚¤ãƒˆ
            const amb = new THREE.AmbientLight(0x606060);
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 1);
            dir.position.set(5, 15, 5);
            dir.castShadow = true;
            scene.add(dir);

            // å®‡å®™èƒŒæ™¯ (æ˜Ÿ)
            const starGeo = new THREE.BufferGeometry();
            const stars = [];
            for(let i=0; i<1000; i++) {
                stars.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*200 - 50);
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(stars, 3));
            const starMat = new THREE.PointsMaterial({color:0xffffff, size:0.2});
            scene.add(new THREE.Points(starGeo, starMat));

            // å®‡å®™èˆ¹ (ãƒ”ã‚¶ã®ç®± = ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‚¾ã‘ã‚‹åºŠ)
            const shipGeo = new THREE.BoxGeometry(8, 0.5, 8);
            const shipMat = new THREE.MeshStandardMaterial({ color: 0x333344, roughness: 0.4 });
            ship = new THREE.Mesh(shipGeo, shipMat);
            ship.receiveShadow = true;
            scene.add(ship);
            
            // è£…é£¾: ã‚¨ãƒ³ã‚¸ãƒ³ãªã©
            const engGeo = new THREE.CylinderGeometry(0.5, 0.2, 2);
            const engMat = new THREE.MeshBasicMaterial({color:0x00aaff});
            const engL = new THREE.Mesh(engGeo, engMat); engL.position.set(-3,0,4); engL.rotation.x=Math.PI/2;
            const engR = new THREE.Mesh(engGeo, engMat); engR.position.set(3,0,4); engR.rotation.x=Math.PI/2;
            ship.add(engL, engR);

            // ãƒ”ã‚¶ (é‹ã¶å¯¾è±¡)
            const pizzaGeo = new THREE.CylinderGeometry(1.5, 1.5, 0.2, 32);
            const pizzaMat = new THREE.MeshStandardMaterial({ color: 0xffaa00 }); // ç”Ÿåœ°
            pizza = new THREE.Mesh(pizzaGeo, pizzaMat);
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°
            const pep = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.22,8), new THREE.MeshBasicMaterial({color:0xcc0000}));
            pep.position.set(0.5,0,0.5); pizza.add(pep);
            const pep2 = pep.clone(); pep2.position.set(-0.5,0,-0.5); pizza.add(pep2);
            
            pizza.position.y = 1;
            pizza.castShadow = true;
            scene.add(pizza);

            // éšœå®³ç‰©ç”Ÿæˆ
            for(let i=0; i<20; i++) {
                const obs = new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random()*1.5+0.5), new THREE.MeshStandardMaterial({color:0x666666}));
                obs.position.set(
                    (Math.random()-0.5)*30,
                    Math.random()*5 - 2,
                    -30 - (i * 15) // å¥¥ã«é…ç½®
                );
                scene.add(obs);
                obstacles.push(obs);
            }

            animate();
        }

        function updateGame() {
            if(!isPlaying) return;

            // 1. å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¸ãƒ£ã‚¤ãƒ­å…¥åŠ›ã‚’å¹³å‡åŒ– (å”åŠ›è¦ç´ )
            let avgTiltX = 0;
            let avgTiltZ = 0;
            
            if (players.length > 0) {
                players.forEach(p => {
                    avgTiltX += p.tilt.x;
                    avgTiltZ += p.tilt.z;
                });
                avgTiltX /= players.length;
                avgTiltZ /= players.length;
            }

            // èˆ¹ã®å‚¾ãé©ç”¨ (æ„Ÿåº¦èª¿æ•´)
            ship.rotation.z = THREE.MathUtils.lerp(ship.rotation.z, -avgTiltX * 1.5, 0.1);
            ship.rotation.x = THREE.MathUtils.lerp(ship.rotation.x, -avgTiltZ * 1.5, 0.1);

            // 2. ãƒ”ã‚¶ã®ç‰©ç† (æ»‘ã‚‹)
            // èˆ¹ã®å‚¾ãã«å¿œã˜ã¦ãƒ”ã‚¶ã«åŠ é€Ÿã‚’åŠ ãˆã‚‹
            pizzaVelocity.x += ship.rotation.z * -0.02; // å³ã«å‚¾ãã¨å³ã¸æ»‘ã‚‹
            pizzaVelocity.z += ship.rotation.x * 0.02;  // å‰ã«å‚¾ãã¨å‰ã¸æ»‘ã‚‹
            
            // æ‘©æ“¦
            pizzaVelocity.multiplyScalar(0.98);

            // ä½ç½®æ›´æ–° (èˆ¹ã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™çš„ãªå‹•ã + ãƒ¯ãƒ¼ãƒ«ãƒ‰ç§»å‹•)
            // ç°¡æ˜“çš„ã«ãƒ”ã‚¶ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’æ›´æ–°
            pizza.position.x += pizzaVelocity.x;
            pizza.position.z += pizzaVelocity.z;
            
            // èˆ¹ã®ä¸Šã«ä¹—ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ã›ã‚‹é«˜ã•èª¿æ•´ (ç°¡æ˜“)
            // èˆ¹ã®ä¸­å¿ƒ(0,0,0)ã‹ã‚‰ã®è·é›¢ã¨å‚¾ãã§Yã‚’æ±ºã‚ã‚‹
            const dx = pizza.position.x - ship.position.x;
            const dz = pizza.position.z - ship.position.z;
            pizza.position.y = ship.position.y + 0.5 - (dx * Math.sin(ship.rotation.z)) + (dz * Math.sin(ship.rotation.x));
            pizza.rotation.copy(ship.rotation); // ãƒ”ã‚¶ã‚‚å‚¾ã

            // 3. ã‚²ãƒ¼ãƒ é€²è¡Œ (å‰é€²)
            const speed = 0.2;
            gameProgress += speed;
            document.getElementById('dist-val').innerText = Math.floor(100 - gameProgress/5);

            // èˆ¹ã¯å°‘ã—æºã‚ŒãªãŒã‚‰ãã®å ´ã«ã„ã‚‹æ¼”å‡ºã€éšœå®³ç‰©ãŒæ‰‹å‰ã«æ¥ã‚‹
            obstacles.forEach(obs => {
                obs.position.z += speed;
                obs.rotation.x += 0.02;
                obs.rotation.y += 0.02;

                // è¡çªåˆ¤å®š
                if (obs.position.distanceTo(pizza.position) < 2.5) {
                    // å½“ãŸã£ãŸã‚‰è·³ã­ã‚‹
                    pizzaVelocity.y += 0.5;
                    pizzaVelocity.x += (Math.random()-0.5);
                    players.forEach(p => p.rumble()); // æŒ¯å‹•
                }

                // ãƒªã‚µã‚¤ã‚¯ãƒ«
                if(obs.position.z > 10) {
                    obs.position.z = -300;
                    obs.position.x = (Math.random()-0.5)*30;
                }
            });

            // 4. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢åˆ¤å®š
            // è½ã¡ãŸï¼Ÿ (èˆ¹ã®ç¯„å›² 4x4 ã‹ã‚‰ã¯ã¿å‡ºãŸã‚‰)
            if (Math.abs(dx) > 4.5 || Math.abs(dz) > 4.5) {
                gameOver("PIZZA LOST...");
            }
            
            // ã‚´ãƒ¼ãƒ«ï¼Ÿ
            if (gameProgress > 500) {
                gameOver("DELIVERY COMPLETE!");
            }
        }

        function gameOver(msg) {
            isPlaying = false;
            const el = document.getElementById('msg-overlay');
            el.innerText = msg;
            el.style.display = 'block';
            el.style.color = msg.includes("LOST") ? "#ff5252" : "#00e676";
            
            if(msg.includes("LOST")) {
                // è½ä¸‹æ¼”å‡º
                pizza.position.y -= 1;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            updateGame();
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>
